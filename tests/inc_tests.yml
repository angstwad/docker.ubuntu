# Tests that role installs as expected with defaults. Which includes with no proxies.
- name: Test that docker is installed with hello-world test
  become: true
  hosts: 
    - ubuntu1204
    - ubuntu1404
    - ubuntu1604
    - debianjessie
  tasks:    
    # Only run this test if there is no proxy.   
    - shell: docker run hello-world
      register: dockeroutput
      when: ("{{ ansible_env.http_proxy is undefined }}" or "{{ ansible_env.http_proxy is none }}" ) and
        docker_http_proxy is undefined
      become: true
    # Fail if hello-world didn't work and we're not behind a proxy
    - fail:
        msg: "'Hello world check failed. Output of shell is:' {{ dockeroutput.stdout_lines }}"
      # Existence of proxy is dected through http_proy env variable. If so docker can't connect to registry to get 
      # hello-world test container.   
      when: (dockeroutput.stdout.find("Hello from Docker!") == -1) and
        not ("{{ ansible_env.http_proxy is defined }}")