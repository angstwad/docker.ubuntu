---
- name: Bring up docker containers
  hosts: localhost
  gather_facts: false
  vars:
    inventory:
      - name: ubuntu1204
        image: "chrismeyers/ubuntu12.04"
      - name: ubuntu1404
        image: "ubuntu:14.04"  
      - name: ubuntu1604
        image: "ubuntu:16.04" 
      - name: debian
        image: "debian:jessie"
    http_proxy_default: 'http://foo.bar.com:3128'
    https_proxy_default: 'https://foo.bar.com:3128' 
  roles:
    - role: provision_docker
      provision_docker_inventory: "{{inventory}}"
      tags: provision_docker

- name: Install python on Debian
  hosts: 
    - ubuntu1604
    - ubuntu1404
  gather_facts: false
  tasks:
    - raw: apt-get update && apt-get -y install python-minimal
  become: true
  
- name: Install lsb release on Debian
  hosts: debian
  gather_facts: false
  tasks:
    - raw: apt-get update && apt-get -y install lsb-release
  become: true
  
- name: Run role and run tests on all supported OSs
  hosts: 
    - ubuntu1204
#     - ubuntu1404
#     - ubuntu1604
#     - debian
  gather_facts: false
  roles:
    - role: docker.ubuntu
      docker_http_proxy: "{{ ansible_env.http_proxy|default({{ http_proxy_default }}) }}"
      docker_https_proxy: "{{ ansible_env.https_proxy|default({{ https_proxy_default }}) }}"
  pre_tasks:
    - name: Gathering facts
      setup:
      
- name: Run tests for all supported environments
  hosts:
    - ubuntu1204
#     - ubuntu1404
#     - ubuntu1604
#     - debian
  tasks:
    - name: Test if HTTP_PROXY environment variable not set
      vars:
        # FIXME the exported variable from the playbook is not there as expected.
        read_http_proxy: "{{ lookup('env','PATH') }}"
      debug:
        msg: "HTTP_PROXY was set to {{ read_http_proxy }}" 
#       fail:
#         msg: "HTTP_PROXY env variable is {{ read_http_proxy }} instead of {{ http_proxy }}"
#       when: ({{ read_http_proxy }} != "http://foo.bar.com:3128") or
#             ({{ read_http_proxy }} is undefined) or 
#             ({{ read_http_proxy }} is none) or 
#             ({{ read_http_proxy }} | trim == '')

- name: Ubuntu 1604 specific tests
  hosts: ubuntu1604
  tasks:
    - name: Tests if http-proxy.conf exists.
      stat: 
        path: /etc/systemd/system/docker.service.d/http-proxy.conf
      register: docker_systemd_file
    - fail:
        msg: "/etc/systemd/system/docker.service.d/http-proxy.conf missing"
      when: not docker_systemd_file.stat.exists

